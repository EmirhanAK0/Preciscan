# Preciscan Project: AI Codebase Guide

## 1. Project Overview
**Preciscan** is a high-precision scanner control system designed to interface with a hardware scanning device (MCU-based) via a PC client. The system architecture follows a **Client-Server** model where the PC acts as the client sending commands and recording data, and the Firmware (MCU) acts as the server executing motion and acquiring data.

This report documents the codebase structure, purpose, and content to facilitate AI-assisted development.

## 2. Directory Structure

The project root contains the following key directories:

### `/pc` (PC Application)
Contains the C++ source code for the PC-side control application.
- **Build System**: CMake (`CMakeLists.txt`). Requires C++17.
- **Key Modules**:
    - `app/`: Application logic (currently empty/placeholder).
    - `core/`: Core business logic and data structures.
        - `config.h/cpp`: Configuration loader (CLI args, file paths).
        - `seq_metrics.h/cpp`: Packet sequence tracking and loss statistics.
        - `metrics_writer.h/cpp`: Disk I/O for recording metrics.
    - `net/`: Network communication (UDP).
        - `udp_receiver.cpp`: Handles incoming UDP packets.
        - `udp_recorder.cpp`: Binds to socket and records raw data.
    - `io/`: File I/O utilities.
        - `replay_reader.cpp`: Reads recorded data for simulation/replay.
    - `tools/`: Executable entry points.
        - `acquire_cli`: Main CLI tool for data acquisition/control.
        - `udp_sender_sim`: Simulator tool to generate traffic for testing.

### `/protocol` (Communication Protocol)
Defines the interface between PC and Firmware.
- **Technology**: Google Protocol Buffers (proto3).
- **Schema**: `schema/commands.proto`
    - **Commands**: `MoveAbs`, `MoveRel`, `Jog`, `Home`, `ScanStart`, `ScanStop`, `Estop`.
    - **Telemetry**: `Status` (state, pos, vel), `Heartbeat`, `Fault`.
    - **Units**: Micrometers (um) for position, um/s for velocity.

### `/firmware` (Embedded Software)
Contains the source code for the Microcontroller Unit (MCU).
- **Status**: Currently skeletal.
- **Structure**:
    - `include/`: Header files.
    - `src/`: Source files (currently empty).
    - `test/`: Unit tests.

## 3. Architecture & Data Flow

### 3.1. Communication Layer
The system uses **UDP** for high-speed data transmission (likely for scan data) and potentially TCP or reliable UDP for control commands (defined in Proto).
- **Proto Definitions**: The `Envelope` message wraps a `msg_id` and `payload`, allowing multiplexing different message types over a single channel.

### 3.2. Data Acquisition Pipeline
1.  **Config**: The system loads configuration (`sim` vs `udp` mode, ports, output files).
2.  **Network/Input**:
    - In `udp` mode: Listens on a raw UDP socket.
    - In `sim` mode: Generates synthetic data or replays a file.
3.  **Core Processing**:
    - `SeqTracker` monitors packet sequence numbers to calculate packet loss rate (`plr`), out-of-order (`ooo`), and duplicates (`dup`).
4.  **Storage**:
    - `MetricsWriter` defines how stats are saved.
    - `MetaWriter` likely saves session metadata.

## 4. Build Instructions

### Prerequisites
- CMake 3.20+
- C++17 compliant compiler (MSVC, GCC, Clang)
- Windows (implied by `ws2_32` linkage in CMake)

### Building the PC Client
```bash
cd pc
mkdir build && cd build
cmake ..
cmake --build .
```

## 5. Key Files for AI Context
When working on this project, an AI should prioritize reading these files:
1.  `protocol/schema/commands.proto`: The "Source of Truth" for capabilities and data types.
2.  `pc/CMakeLists.txt`: Dependencies and build targets.
3.  `pc/core/config.h`: Available configuration options and runtime modes.
4.  `pc/core/seq_metrics.h`: Definitions of data quality metrics.

---
*Generated by Antigravity AI Agent on 2026-02-18*
